name: CI/CD

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

# concurrency required to avoid terraform lock contention during ECR provisioning
concurrency: cicd-${{ github.repository }}-pipeline

jobs:

  Setup: # Bolster
    runs-on: ubuntu-latest
    steps:
      - name: Placeholder
        run: echo setting up!


  deploy-dev:
    name: Deploy FE & BE to Dev Env
    if: github.event_name == 'pull_request'
    needs: [Setup]
    runs-on: ubuntu-latest

    environment:
      name: development

    steps:
      - name: Deploy
        uses: ./.github/workflows/deploy.yml
        with:
          environment: development
          AWS_REGION: ${{ vars.AWS_REGION }}
          BACKEND_S3_BUCKET: ${{ vars.BACKEND_S3_BUCKET }}
          AWS_GITHUB_ACCESS_ROLE: ${{ secrets.AWS_GITHUB_ACCESS_ROLE }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        
            
  deploy-test:
    name: Deploy FE & BE to Test Env
    if: github.event.ref == 'refs/heads/master'
    needs: [Setup]
    runs-on: ubuntu-latest

    environment:
      name: testing

    steps:
      - name: Deploy
        uses: ./.github/workflows/deploy.yml
        with:
          environment: testing
          AWS_REGION: ${{ vars.AWS_REGION }}
          BACKEND_S3_BUCKET: ${{ vars.BACKEND_S3_BUCKET }}
          AWS_GITHUB_ACCESS_ROLE: ${{ secrets.AWS_GITHUB_ACCESS_ROLE }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        
        
  deploy-qa:
    name: Deploy FE & BE to QA Env
    needs: [deploy-test]
    runs-on: ubuntu-latest

    environment:
      name: qa

    steps:
      - name: Deploy
        uses: ./.github/workflows/deploy.yml
        with:
          environment: qa
          AWS_REGION: ${{ vars.AWS_REGION }}
          BACKEND_S3_BUCKET: ${{ vars.BACKEND_S3_BUCKET }}
          AWS_GITHUB_ACCESS_ROLE: ${{ secrets.AWS_GITHUB_ACCESS_ROLE }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
