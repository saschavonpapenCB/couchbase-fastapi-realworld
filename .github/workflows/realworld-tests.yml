---
name: Realworld Tests

on:
  push:
    branches:
      main
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 10 * * 1"

jobs:
  realworld-tests:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    env:
      DB_CONN_STR: ${{ vars.DB_CONN_STR }}
      DB_BUCKET_NAME: ${{ vars.DB_BUCKET_NAME }}
      DB_SCOPE_NAME: ${{ vars.DB_SCOPE_NAME }}
      DB_USERNAME: ${{ vars.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

    steps:
      - uses: actions/checkout@v1
        with:
          submodules: recursive
      - name: Print Action Variables
        run: |
          echo "Action Variable 1: ${{ vars.DB_CONN_STR }}"
          echo "Action Variable 2: ${{ vars.DB_BUCKET_NAME }}"
          echo "Action Variable 3: ${{ vars.DB_USERNAME }}"
          echo "Action Variable 4: ${{ vars.DB_SCOPE_NAME }}"
          echo "Action Secret: ${{ secrets.DB_PASSWORD }}"
      - name: Set up Python and requirements
        run: |
          sudo apt -y update
          sudo apt -y install python3-pip python3-testresources
          python -m pip install -r requirements.txt
      - name: Start the FastAPI server
        run: |
          ./scripts/start-api.sh &
          # Wait for the server
          while ! curl "http://localhost:8000/health" > /dev/null 2>&1
          do
            sleep 1;
          done
          echo "Server ready."
      - name: Run realworld backend tests
        run: ./scripts/realworld-test.sh
        env:
          APIURL: http://localhost:8000
